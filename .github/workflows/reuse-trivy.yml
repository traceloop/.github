name: reuse-trivy

on:
  workflow_call:
    inputs:
      docker_context:
        type: string
        required: false
        default: "."
      image_name:
        type: string
        required: false
        default: "my-app"
      dockerfile:
        type: string
        required: false
        default: "Dockerfile"
      platforms:
        type: string
        required: false
        default: "amd64"
        description: "Comma-separated platforms (e.g., 'amd64,arm64')"
    secrets:
      GH_ACCESS_TOKEN:
        required: false
        description: "GitHub token for private repo access during Docker build"
      DOPPLER_TOKEN:
        required: false
        description: "Doppler token for build-time environment variables"

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set up matrix
        id: set-matrix
        env:
          PLATFORMS: ${{ inputs.platforms }}
        run: |
          json=$(echo "${PLATFORMS}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s -c '{platform: .}')
          echo "matrix=$json" >> $GITHUB_OUTPUT

  trivy:
    needs: setup
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.platform == 'arm64' && 'Linux-ARM64' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache Trivy
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-${{ runner.os }}-${{ matrix.platform }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          secrets=()
          [ -n "${GH_ACCESS_TOKEN}" ] && secrets+=(--secret id=gh_token,env=GH_ACCESS_TOKEN)
          [ -n "${DOPPLER_TOKEN}" ] && secrets+=(--secret id=doppler_token,env=DOPPLER_TOKEN)
          
          docker buildx build \
            --load \
            -t "${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}" \
            -f "${{ inputs.docker_context }}/${{ inputs.dockerfile }}" \
            "${secrets[@]}" \
            "${{ inputs.docker_context }}"

      - name: Trivy scan (SARIF)
        if: (github.event_name == 'push' || github.event_name == 'schedule') && github.ref == 'refs/heads/main'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}
          format: sarif
          output: trivy-results-${{ matrix.platform }}.sarif
          vuln-type: os,library
          severity: CRITICAL,HIGH,MEDIUM,LOW

      - name: Upload SARIF to GitHub Security
        if: (github.event_name == 'push' || github.event_name == 'schedule') && github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-${{ matrix.platform }}.sarif
          category: container-security-${{ matrix.platform }}

      - name: Trivy scan for PR comment
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}
          format: table
          output: trivy-results-${{ matrix.platform }}.txt
          vuln-type: os,library
          severity: CRITICAL,HIGH,MEDIUM,LOW

      - name: Prepare PR comment
        if: github.event_name == 'pull_request'
        run: |
          {
            echo "## ðŸ”’ Container Vulnerability Scan (${{ matrix.platform }})"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand results</summary>"
            echo ""
            echo '```'
            cat trivy-results-${{ matrix.platform }}.txt
            echo '```'
            echo ""
            echo "</details>"
          } > trivy-comment-${{ matrix.platform }}.md

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trivy-scan-${{ matrix.platform }}
          path: trivy-comment-${{ matrix.platform }}.md

