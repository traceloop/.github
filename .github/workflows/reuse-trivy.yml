name: reuse-trivy

on:
  workflow_call:
    inputs:
      docker_context:
        type: string
        required: false
        default: "."
      image_name:
        type: string
        required: false
        default: "my-app"
      dockerfile:
        type: string
        required: false
        default: "Dockerfile"
      platforms:
        type: string
        required: false
        default: "amd64"
        description: "Comma-separated platforms (e.g., 'amd64,arm64')"
      arm_runner:
        type: string
        required: false
        default: "Linux-ARM64"
        description: "Runner to use for ARM builds (default: Linux-ARM64)"
    secrets:
      GH_ACCESS_TOKEN:
        required: false
        description: "GitHub token for private repo access during Docker build"
      DOPPLER_TOKEN:
        required: false
        description: "Doppler token for build-time environment variables"

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set up matrix
        id: set-matrix
        env:
          PLATFORMS: ${{ inputs.platforms }}
        run: |
          json=$(echo "${PLATFORMS}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s -c '{platform: .}')
          echo "matrix=$json" >> $GITHUB_OUTPUT

  trivy:
    needs: setup
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.platform == 'arm64' && inputs.arm_runner || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache Trivy
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-${{ runner.os }}-${{ matrix.platform }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          secrets=()
          [ -n "${GH_ACCESS_TOKEN}" ] && secrets+=(--secret id=gh_token,env=GH_ACCESS_TOKEN)
          [ -n "${DOPPLER_TOKEN}" ] && secrets+=(--secret id=doppler_token,env=DOPPLER_TOKEN)
          
          docker buildx build \
            --load \
            -t "${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}" \
            -f "${{ inputs.docker_context }}/${{ inputs.dockerfile }}" \
            "${secrets[@]}" \
            "${{ inputs.docker_context }}"

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0
        with:
          version: v0.68.2

      - name: Trivy scan (JSON) and convert
        env:
          TRIVY_CACHE_DIR: ~/.cache/trivy
        run: |
          set -euo pipefail

          IMAGE="${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}"
          PREFIX="trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}"
          JSON="${PREFIX}.json"
          TXT="${PREFIX}.txt"
          SARIF="${PREFIX}.sarif"

          SCAN_ARGS="--vuln-type os,library --severity CRITICAL,HIGH,MEDIUM,LOW --cache-dir ${TRIVY_CACHE_DIR}"

          # Scan once -> JSON
          trivy image $SCAN_ARGS --format json --output "$JSON" "$IMAGE"

          # Always convert -> table (for logs + PR comment)
          trivy convert --format table --output "$TXT" "$JSON"

          # Convert -> SARIF only on main branch
          if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            trivy convert --format sarif --output "$SARIF" "$JSON"
          fi

      - name: Log full Trivy results
        run: |
          echo "::group::Full Trivy Scan Results (${{ inputs.image_name }} - ${{ matrix.platform }})"
          cat trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.txt
          echo "::endgroup::"

      - name: Upload SARIF to GitHub Security
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.sarif
          category: container-security-${{ inputs.image_name }}-${{ matrix.platform }}

      - name: Prepare PR comment
        if: github.event_name == 'pull_request'
        run: |
          RESULTS_FILE="trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.txt"
          COMMENT_FILE="trivy-comment-${{ inputs.image_name }}-${{ matrix.platform }}.md"
          MAX_CHARS=60000

          # Get file size
          FILE_SIZE=$(wc -c < "$RESULTS_FILE")

          {
            echo "## ðŸ”’ Container Vulnerability Scan (${{ inputs.image_name }} - ${{ matrix.platform }})"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand results</summary>"
            echo ""
            echo '```'
            if [ "$FILE_SIZE" -gt "$MAX_CHARS" ]; then
              head -c "$MAX_CHARS" "$RESULTS_FILE"
              echo ""
              echo "... (output truncated - exceeded ${MAX_CHARS} characters)"
              echo "See full results in the 'Full Trivy Scan Results' step above"
            else
              cat "$RESULTS_FILE"
            fi
            echo '```'
            echo ""
            echo "</details>"
          } > "$COMMENT_FILE"

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trivy-scan-${{ inputs.image_name }}-${{ matrix.platform }}
          path: trivy-comment-${{ inputs.image_name }}-${{ matrix.platform }}.md

