name: reuse-trivy

on:
  workflow_call:
    inputs:
      # Image scanning
      scan_image:
        type: boolean
        required: false
        default: true
        description: "Scan Docker image for vulnerabilities"
      docker_context:
        type: string
        required: false
        default: "."
      image_name:
        type: string
        required: false
        default: "my-app"
      dockerfile:
        type: string
        required: false
        default: "Dockerfile"
      platforms:
        type: string
        required: false
        default: "amd64"
        description: "Comma-separated platforms (e.g., 'amd64,arm64')"
      arm_runner:
        type: string
        required: false
        default: "Linux-ARM64"
        description: "Runner to use for ARM builds (default: Linux-ARM64)"
      # Helm chart scanning
      scan_helm_chart:
        type: boolean
        required: false
        default: false
        description: "Scan Helm chart for misconfigurations"
      helm_chart_path:
        type: string
        required: false
        default: "helm/"
        description: "Path to Helm chart directory (e.g., 'helm/' or 'charts/myapp')"
      helm_chart_name:
        type: string
        required: false
        default: "helm"
        description: "Chart name for output/categories"
      helm_values_files:
        type: string
        required: false
        default: ""
        description: "Comma-separated paths to values files (e.g., 'helm/values.yaml,overlays/values-prod.yaml')"
    secrets:
      GH_ACCESS_TOKEN:
        required: false
        description: "GitHub token for private repo access during Docker build"
      DOPPLER_TOKEN:
        required: false
        description: "Doppler token for build-time environment variables"

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

jobs:
  setup:
    if: inputs.scan_image
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set up matrix
        id: set-matrix
        env:
          PLATFORMS: ${{ inputs.platforms }}
        run: |
          json=$(echo "${PLATFORMS}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s -c '{platform: .}')
          echo "matrix=$json" >> $GITHUB_OUTPUT

  image-scan:
    if: inputs.scan_image
    needs: setup
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.platform == 'arm64' && inputs.arm_runner || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache Trivy
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-${{ runner.os }}-${{ matrix.platform }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          secrets=()
          [ -n "${GH_ACCESS_TOKEN}" ] && secrets+=(--secret id=gh_token,env=GH_ACCESS_TOKEN)
          [ -n "${DOPPLER_TOKEN}" ] && secrets+=(--secret id=doppler_token,env=DOPPLER_TOKEN)
          
          docker buildx build \
            --load \
            -t "${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}" \
            -f "${{ inputs.docker_context }}/${{ inputs.dockerfile }}" \
            "${secrets[@]}" \
            "${{ inputs.docker_context }}"

      - name: Trivy scan (JSON)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ inputs.image_name }}:${{ github.sha }}-${{ matrix.platform }}
          format: json
          output: trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.json
          vuln-type: os,library
          severity: CRITICAL,HIGH,MEDIUM,LOW

      - name: Convert Trivy results
        run: |
          set -euo pipefail
          PREFIX="trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}"

          # Convert -> table (for logs + PR comment)
          trivy convert --format table --output "${PREFIX}.txt" "${PREFIX}.json"

          # Convert -> SARIF only on main branch
          if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            trivy convert --format sarif --output "${PREFIX}.sarif" "${PREFIX}.json"
          fi

      - name: Upload SARIF to GitHub Security
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.sarif
          category: container-security-${{ inputs.image_name }}-${{ matrix.platform }}

      - name: Log full Trivy results
        run: |
          echo "::group::Full Trivy Scan Results (${{ inputs.image_name }} - ${{ matrix.platform }})"
          cat trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.txt
          echo "::endgroup::"

      - name: Prepare PR comment
        if: github.event_name == 'pull_request'
        run: |
          RESULTS_FILE="trivy-results-${{ inputs.image_name }}-${{ matrix.platform }}.txt"
          COMMENT_FILE="trivy-comment-${{ inputs.image_name }}-${{ matrix.platform }}.md"
          MAX_CHARS=60000

          # Get file size
          FILE_SIZE=$(wc -c < "$RESULTS_FILE")

          {
            echo "## ðŸ”’ Container Vulnerability Scan (${{ inputs.image_name }} - ${{ matrix.platform }})"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand results</summary>"
            echo ""
            echo '```'
            if [ "$FILE_SIZE" -gt "$MAX_CHARS" ]; then
              head -c "$MAX_CHARS" "$RESULTS_FILE"
              echo ""
              echo "... (output truncated - exceeded ${MAX_CHARS} characters)"
              echo "See full results in the 'Full Trivy Scan Results' step above"
            else
              cat "$RESULTS_FILE"
            fi
            echo '```'
            echo ""
            echo "</details>"
          } > "$COMMENT_FILE"

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trivy-scan-${{ inputs.image_name }}-${{ matrix.platform }}
          path: trivy-comment-${{ inputs.image_name }}-${{ matrix.platform }}.md

  helm-scan:
    if: inputs.scan_helm_chart
    runs-on: ubuntu-latest
    env:
      CHART_NAME: ${{ inputs.helm_chart_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache Trivy
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-helm-${{ runner.os }}
          restore-keys: |
            trivy-helm-

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1
        with:
          version: 'v3.15.4'

      - name: Render Helm chart
        env:
          CHART_PATH: ${{ inputs.helm_chart_path }}
          VALUES_FILES: ${{ inputs.helm_values_files }}
        run: |
          set -euo pipefail
          
          # Validate chart exists
          if [ ! -f "$CHART_PATH/Chart.yaml" ]; then
            echo "Chart.yaml not found under $CHART_PATH" >&2
            exit 1
          fi
          
          # Build dependencies if Chart.lock exists
          if [ -f "$CHART_PATH/Chart.lock" ]; then
            helm dependency build "$CHART_PATH"
          fi
          
          # Build template command with optional values files
          TEMPLATE_ARGS=()
          if [ -n "$VALUES_FILES" ]; then
            IFS=',' read -ra FILES <<< "$VALUES_FILES"
            for f in "${FILES[@]}"; do
              TEMPLATE_ARGS+=(-f "$f")
            done
          fi
          
          helm template trivy-scan "$CHART_PATH" "${TEMPLATE_ARGS[@]}" > "rendered-${CHART_NAME}.yaml"

      - name: Trivy config scan rendered manifests (JSON)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: rendered-${{ env.CHART_NAME }}.yaml
          format: json
          output: trivy-helm-${{ env.CHART_NAME }}.json
          severity: CRITICAL,HIGH,MEDIUM,LOW
          scanners: misconfig
          misconfig-scanners: kubernetes

      - name: Convert Helm results
        run: |
          set -euo pipefail
          trivy convert --format table --output "trivy-helm-${CHART_NAME}.txt" "trivy-helm-${CHART_NAME}.json"

          if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            trivy convert --format sarif --output "trivy-helm-${CHART_NAME}.sarif" "trivy-helm-${CHART_NAME}.json"
          fi

      - name: Upload Helm SARIF to GitHub Security
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-helm-${{ env.CHART_NAME }}.sarif
          category: helm-misconfig-${{ github.repository }}-${{ env.CHART_NAME }}

      - name: Log Helm scan results
        run: |
          echo "::group::Helm Misconfiguration Results (${CHART_NAME})"
          cat "trivy-helm-${CHART_NAME}.txt"
          echo "::endgroup::"

      - name: Prepare Helm PR comment
        if: github.event_name == 'pull_request'
        run: |
          MAX_CHARS=60000
          FILE_SIZE=$(wc -c < "trivy-helm-${CHART_NAME}.txt")

          {
            echo "## Helm Chart Misconfiguration Scan (${CHART_NAME})"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand results</summary>"
            echo ""
            echo '```'
            if [ "$FILE_SIZE" -gt "$MAX_CHARS" ]; then
              head -c "$MAX_CHARS" "trivy-helm-${CHART_NAME}.txt"
              echo ""
              echo "... (output truncated - exceeded ${MAX_CHARS} characters)"
              echo "See full results in the 'Helm Misconfiguration Results' step above"
            else
              cat "trivy-helm-${CHART_NAME}.txt"
            fi
            echo '```'
            echo ""
            echo "</details>"
          } > "trivy-helm-comment-${CHART_NAME}.md"

      - name: Post Helm PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trivy-helm-${{ env.CHART_NAME }}
          path: trivy-helm-comment-${{ env.CHART_NAME }}.md

